import software.amazon.awssdk.services.personalize.PersonalizeClient;
import software.amazon.awssdk.services.personalize.model.*;

public class RecommendationService {

    private final PersonalizeClient personalizeClient;

    public RecommendationService() {
        // initialize the Personalize client
        this.personalizeClient = PersonalizeClient.builder().region(Region.EU_NORTH_1).build();
    }

    // import data into personalise 
    public void createDatasetImportJob() {
        CreateDatasetImportJobRequest importJobRequest = new CreateDatasetImportJobRequest()
            .withJobName("import-job")
            .withDatasetArn("ecopath-dataset-arn")
            .withDataSource(new DataSource().withDataLocation("s3://hackhubbucket/data.csv"))
            .withRoleArn("rec-role");
        personalizeClient.createDatasetImportJob(importJobRequest);
    }

    // create pseronalise solution from data 
    public String createSolution(String datasetGroupArn) {
        CreateSolutionRequest solutionRequest = CreateSolutionRequest.builder()
            .name("travel-recommendation-solution")
            .datasetGroupArn(datasetGroupArn)
            .recipeArn("arn:aws:personalize:::recipe/aws-user-personalization")
            .build();
        String solutionArn = personalizeClient.createSolution(solutionRequest).solutionArn();
        return solutionArn;
    }

    // build solution
    public String createSolutionVersion(String solutionArn) {
        CreateSolutionVersionRequest solutionVersionRequest = CreateSolutionVersionRequest.builder()
            .solutionArn(solutionArn)
            .build();
        String solutionVersionArn = personalizeClient.createSolutionVersion(solutionVersionRequest).solutionVersionArn();
        return solutionVersionArn;
    }

    // build personalise campaign 
    public String createCampaign(String solutionVersionArn) {
        CreateCampaignRequest campaignRequest = new CreateCampaignRequest()
            .name("my-campaign")
            .solutionVersionArn(solutionVersionArn)
            .minProvisionedTPS(1);
        String campaignArn = personalizeClient.createCampaign(campaignRequest).getCampaignArn();
        return campaignArn;
    }


    public TravelRecommendation[] getTravelRecommendations(String campaignArn, String userId, String weather) {
        // Request recommendations
        GetRecommendationsRequest recommendationsRequest = new GetRecommendationsRequest()
            .withCampaignArn(campaignArn)
            .withUserId(userId);
        List<TravelRecommendation> recommendationList = personalizeClient.getRecommendations(recommendationsRequest).itemList();
    
        // Define priorities based on weather conditions
        Map<String, List<String>> weatherToPriorityMap = new HashMap<>();
        weatherToPriorityMap.put("sunny", Arrays.asList("walk", "cycle"));
        weatherToPriorityMap.put("rainy", Arrays.asList("public_bus"));
    
        // Create comparator to prioritize items based on weather
        Comparator<TravelRecommendation> itemComparator = (item1, item2) -> {
            List<String> priorityItems = weatherToPriorityMap.get(weather.toLowerCase());
            boolean item1IsPriority = priorityItems.contains(item1.itemId());
            boolean item2IsPriority = priorityItems.contains(item2.itemId());
    
            if (item1IsPriority && !item2IsPriority) {
                return -1;
            } else if (!item1IsPriority && item2IsPriority) {
                return 1;
            } else {
                return 0;
            }
        };
    
        // Sort the recommendation list
        recommendationList.sort(itemComparator);
    
        // Convert list to array and return
        return recommendationList.toArray(TravelRecommendation[]::new);
    }
}
